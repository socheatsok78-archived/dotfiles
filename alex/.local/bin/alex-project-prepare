#!/usr/bin/env bash

function shell_output () {
    echo "-----> $@"
}

# Check if JQ is insalled
function check_jq () {
    if ! [ `command -v jq` ]; then
        echo "Command: jq is not installed"
        echo "Please install jq:"
        echo "\tbrew install jq"
        return 2
    fi
}

# Composer Task
function task_composer () {
    if [ -f "composer.json" ]; then
        shell_output "Installing dependencies..."
        composer --version

        if [ -f "composer.lock" ]; then
            composer update
        else
            composer install
        fi
    fi
}

# NodeJS Task
function task_node () {
    if [ -f "package.json" ]; then
        shell_output "Installing dependencies..."

        local npm_bin="npm"
        if [ `command -v yarn` ]; then
            local npm_bin='yarn' # Prefer yarn
        fi
        
        if [ -f "package-lock.json" ]; then
            npm install
        elif [ -f "yarn.lock" ]; then
            $npm_bin install
        else
            $npm_bin install
        fi
    fi
}

# Check if Composer Script Exist
function composer_has_script () {
    local script=$1
    shift
    
    cat composer.json | jq -eM ".scripts" | grep "$script" >/dev/null
}

# Check if Composer Package Exist
function composer_has_package () {
    local package=$1
    shift

    composer info | awk '{print $1}' | grep "$package" 1>/dev/null
}

# Run Composer Script
function composer_run_script () {
    local script=$1
    shift

    if `composer_has_script "$script"`; then
        composer run "$script"
    fi
}

# Check if current working project is laravel
function is_project_laravel () {
    composer info | awk '{print $1}' | grep "laravel/framework" 1>/dev/null
}

# Laravel Task
function task_laravel () {
    if is_project_laravel; then
        shell_output "Laravel project detected"

        if ! [ -f ".env" ]; then
            shell_output "Creating runtime environment"
            composer_run_script "post-root-package-install"
            composer_run_script "post-create-project-cmd"
        fi
    fi
}

# main()
function main () {
    shell_output "Preparing runtime environment"

    task_composer
    task_node

    task_laravel

    shell_output "Project prepared!"
}

# Entrypoint
main
